{% extends "pilot/base.html" %}
{% load widget_tweaks %}
{% block content %}

<div class="max-w-4xl mx-auto mt-8 p-6 bg-white shadow-md rounded-lg">
  <h2 class="text-2xl font-bold text-cacf-dark mb-6">Créer une Analyse</h2>

  <!-- STEP 1: Filter form (GET) -->
  <form method="get" class="space-y-6">
    <div>
      <label for="{{ form.categorie.id_for_label }}" class="block text-sm font-medium text-gray-700">
        {{ form.categorie.label }}
      </label>
      {{ form.categorie|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cacf-green focus:ring-cacf-green" }}
    </div>

    <div>
      <input type="hidden" name="filter" value="1">
      <button type="submit" class="bg-cacf-green text-white px-4 py-2 rounded hover:bg-cacf-dark transition">
        Filtrer les indicateurs
      </button>
    </div>
  </form>

  {% if filter_mode %}
  <!-- STEP 2: Actual Analysis form (POST) -->
  <form method="post" class="space-y-6 mt-10">
    {% csrf_token %}

    {% if form.errors %}
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
        <strong>Erreur :</strong> Veuillez corriger les champs suivants :
        <ul class="mt-2 list-disc list-inside text-sm">
          {% for field in form %}
            {% for error in field.errors %}
              <li><strong>{{ field.label }}:</strong> {{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Title -->
    <div>
      <label for="{{ form.titre.id_for_label }}" class="block text-sm font-medium text-gray-700">
        {{ form.titre.label }}
      </label>
      {{ form.titre|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cacf-green focus:ring-cacf-green" }}
    </div>

    <!-- Description -->
    <div>
      <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700">
        {{ form.description.label }}
      </label>
      {{ form.description|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cacf-green focus:ring-cacf-green" }}
    </div>

    <!-- Chart Type -->
    <div>
      <label for="{{ form.chart_type.id_for_label }}" class="block text-sm font-medium text-gray-700">
        {{ form.chart_type.label }}
      </label>
      {{ form.chart_type|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cacf-green focus:ring-cacf-green" }}
    </div>

    <!-- Category (read-only, already selected) -->
    <div>
      <label for="{{ form.categorie.id_for_label }}" class="block text-sm font-medium text-gray-700">
        {{ form.categorie.label }}
      </label>
      {{ form.categorie|add_class:"mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm" }}
    </div>

    <!-- KPI Names -->
    <div>
      <label for="{{ form.kpi_names.id_for_label }}" class="block text-sm font-medium text-gray-700">
        {{ form.kpi_names.label }}
      </label>
      {{ form.kpi_names|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cacf-green focus:ring-cacf-green" }}
    </div>

    <!-- Date Range -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="{{ form.date_debut.id_for_label }}" class="block text-sm font-medium text-gray-700">
          Date de début
        </label>
        {{ form.date_debut|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cacf-green focus:ring-cacf-green" }}
      </div>
      <div>
        <label for="{{ form.date_fin.id_for_label }}" class="block text-sm font-medium text-gray-700">
          Date de fin
        </label>
        {{ form.date_fin|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-cacf-green focus:ring-cacf-green" }}
      </div>
    </div>

    <!-- Published -->
    <div class="flex items-center">
      {{ form.is_published|add_class:"h-4 w-4 text-cacf-green border-gray-300 rounded focus:ring-cacf-green" }}
      <label for="{{ form.is_published.id_for_label }}" class="ml-2 block text-sm font-medium text-gray-700">
        {{ form.is_published.label }}
      </label>
    </div>

    <!-- Submit Button -->
    <div>
      <button type="submit" class="w-full bg-cacf-green text-white px-4 py-2 rounded-md shadow hover:bg-cacf-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cacf-green">
        Enregistrer l'analyse
      </button>
    </div>
  </form>
  {% endif %}
</div>

<!-- Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  $(document).ready(function() {
    $('#id_kpi_names').select2({
      placeholder: 'Sélectionner une ou plusieurs descriptions',
      width: '100%'
    });
  });
</script>

{% endblock %}
